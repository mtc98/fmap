<!DOCTYPE html>
<html>
<head>
    <title>å°ä¸­ YouBike 2.0 åœ°åœ–</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #fff9e6;
        }

        #æ¨™é¡Œ {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            color: #1976d2;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid #1976d2;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #æ¨™é¡Œ img {
            height: 24px;
            width: auto;
            vertical-align: middle;
        }

        #æ¨™é¡Œ:hover {
            background-color: #f0f7ff;
        }

        #åœ°åœ–å®¹å™¨ {
            height: 100vh;
            width: 100vw;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        #å·¦å´é¢æ¿ {
            position: fixed;
            top: 90px;
            left: 30px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 12px 10px 10px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #å³å´æ§åˆ¶ {
            position: fixed;
            top: 20px;
            right: 30px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 10px 10px 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
        }

        /* å·¦ä¸‹è§’ï¼š2D ç”¨ YouBike é¢æ¿ - ç½®ä¸­é¡¯ç¤º */
        #youbikePanel2D {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            padding: 10px 10px 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 220px;
            max-width: 90vw;
            max-height: 70vh;
            overflow-y: auto;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* 2D å·¦ä¸‹è§’é¢æ¿åˆ‡æ›æŒ‰éˆ•ï¼ˆé¡¯ç¤º/éš±è— Ubike é¢æ¿ï¼‰ */
        #youbikeToggleBtn {
            position: fixed;
            bottom: 70px;
            left: 20px; /* èˆ‡é¢æ¿éŒ¯é–‹ï¼Œé¿å…é®è“‹ */
            z-index: 25;
            width: 44px;
            height: 44px;
            background: #EEE8AA; /* æ·¡é»ƒé‡‘ */
            color: #5a4a00;
        }
        #youbikeToggleBtn:hover { background: #e99051; }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            color: #222;
        }

        .control-group input[type="range"] {
            width: 200px;
        }

        .æ™¯é»æŒ‰éˆ• {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #e3eaff;
            color: #222296;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .æ™¯é»æŒ‰éˆ•:hover {
            background: #b6c8ff;
        }

        #ç›¸æ©Ÿè³‡è¨Š {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 18px;
            font-size: 14px;
            z-index: 30;
            box-sizing: border-box;
            min-width: 320px;
            max-width: 95vw;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #ç›¸æ©Ÿè³‡è¨Š.éš±è— {
            transform: translate(-50%, calc(-50% + 100vh));
            opacity: 0;
            pointer-events: none;
        }

        #ç›¸æ©Ÿåƒæ•¸é¡¯ç¤º {
            margin-bottom: 8px;
            font-weight: bold;
        }

        #åµéŒ¯è³‡è¨Šå€å¡Š {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        #åµéŒ¯æ¨™é¡Œ {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
            cursor: pointer;
            user-select: none;
        }

        #åµéŒ¯æ¨™é¡Œ:hover {
            color: #222296;
        }

        #åµéŒ¯å…§å®¹ {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.04);
            padding: 12px;
            border-radius: 6px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .åµéŒ¯æ‘ºç–Š {
            max-height: 0 !important;
            padding: 0 6px !important;
            opacity: 0;
        }

        /* é¢æ¿åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .é¢æ¿åˆ‡æ›æŒ‰éˆ• {
            position: fixed;
            z-index: 25;
            background: rgba(34, 34, 150, 0.95);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .é¢æ¿åˆ‡æ›æŒ‰éˆ•:hover {
            background: rgb(49, 180, 224);
            transform: scale(1.1);
        }

        /* 2D/3D åˆ‡æ›æŒ‰éˆ•å’Œå®šä½è³‡è¨ŠæŒ‰éˆ•ï¼šç™½åº•è—å­— */
        #mapToggleBtn,
        #toggleDebugBtn {
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
            font-weight: bold;
            font-size: 18px;
            z-index: 40; /* ç¢ºä¿åœ¨å®šä½è³‡è¨Šé¢æ¿ä¹‹ä¸Š */
        }
        #mapToggleBtn:hover,
        #toggleDebugBtn:hover {
            background: #e3f2fd;
        }

        /* YouBike æŒ‰éˆ•å’Œå®šä½æŒ‰éˆ•ï¼šæ·¡é»ƒåº•è‰² */
        #youbikeToggleBtn,
        #locationBtn {
            background: #EEE8AA; /* palegoldenrod æ·¡é»ƒé‡‘ */
            color: #5a4a00;
            z-index: 40; /* ç¢ºä¿åœ¨å®šä½è³‡è¨Šé¢æ¿ä¹‹ä¸Š */
        }
        #youbikeToggleBtn:hover,
        #locationBtn:hover {
            background: #e9d97f; /* ç¨å¾®åŠ æ·±çš„æ·¡é»ƒé‡‘ */
        }

        /* å³å´é¢æ¿ä¸­çš„åŠŸèƒ½æŒ‰éˆ•ä½¿ç”¨æ·¡é»ƒé‡‘åº•è‰²ï¼Œä¸å½±éŸ¿å·¦å´é¢æ¿æŒ‰éˆ• */
        #å³å´æ§åˆ¶ .æ™¯é»æŒ‰éˆ• {
            background: #F7E7A1;
            color: #5a4a00;
        }
        #å³å´æ§åˆ¶ .æ™¯é»æŒ‰éˆ•:hover {
            background: #E9D784;
        }

        #leftPanelToggle {
            top: 70px;
            left: 15px;
        }
        #rightPanelToggle {
            top: 70px;
            right: 15px;
        }

        /* é¢æ¿éš±è—ç‹€æ…‹ */
        .é¢æ¿éš±è— {
            opacity: 0;
            pointer-events: none;
        }

        /* é¢æ¿éæ¸¡å‹•ç•« */
        #å·¦å´é¢æ¿, #å³å´æ§åˆ¶, #youbikePanel2D {
            transition: all 0.3s ease;
        }

        .youbikeé¢æ¿éš±è— {
            transform: translate(-50%, calc(-50% + 100vh)) !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* å³ä¸Šè§’å›ºå®šè³‡è¨Šé¢æ¿ */
        #spot-info-panel {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            padding: 20px;
            z-index: 30;
            font-family: Arial, sans-serif;
            border: 1px solid rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        /* æ¡Œé¢ç‰ˆæ¨£å¼ */
        @media (min-width: 768px) {
            #spot-info-panel {
                top: 70px;
                right: 15px;
                width: 350px;
                max-height: 500px;
            }
        }

        /* ç§»å‹•è¨­å‚™æ¨£å¼ */
        @media (max-width: 767px) {
            #spot-info-panel {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 85vw;
                max-width: 320px;
                max-height: 70vh;
            }

            /* ç§»å‹•è¨­å‚™ä¸Šçš„æ¨™é¡Œèª¿æ•´ */
            #æ¨™é¡Œ {
                font-size: 12px !important;
                padding: 8px 15px !important;
                gap: 6px !important;
                white-space: nowrap;
                max-width: 90vw;
            }

            #æ¨™é¡Œ img {
                height: 20px !important;
            }

            /* ç§»å‹•è¨­å‚™ä¸Šçš„ç…§ç‰‡é«˜åº¦èª¿æ•´ */
            #spot-info-panel .spot-image {
                height: 150px !important;
            }

            /* ç§»å‹•è¨­å‚™ä¸Šçš„æ¨™é¡Œå­—é«”èª¿æ•´ */
            #spot-info-panel h3 {
                font-size: 16px !important;
            }

            /* ç§»å‹•è¨­å‚™ä¸Šçš„å…§å®¹å­—é«”èª¿æ•´ */
            #spot-info-panel p {
                font-size: 13px !important;
            }

            /* ç§»å‹•è¨­å‚™ä¸Šçš„è³‡è¨Šé¢æ¿èª¿æ•´ */
            #ç›¸æ©Ÿè³‡è¨Š {
                min-width: 280px !important;
                max-width: 92vw !important;
                padding: 15px !important;
            }

            #åµéŒ¯å…§å®¹ {
                font-size: 12px !important;
                max-height: 350px !important;
                padding: 10px !important;
            }

            #åµéŒ¯æ¨™é¡Œ {
                font-size: 14px !important;
            }
        }

        /* æ™¯é»ç…§ç‰‡æ¨£å¼ */
        #spot-info-panel .spot-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        #spot-info-panel .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        #spot-info-panel .close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        #spot-info-panel h3 {
            margin: 0 0 12px 0;
            color: #2222A0;
            font-size: 18px;
            padding-right: 30px;
        }

        #spot-info-panel p {
            margin: 0 0 8px 0;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }

        #spot-info-panel .tour-btn {
            background: linear-gradient(145deg, #4285f4, #1a73e8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 3px 8px rgba(66, 133, 244, 0.3);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #spot-info-panel .tour-btn:hover {
            background: linear-gradient(145deg, #1a73e8, #1557b0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }

        #spot-info-panel .tour-btn:active {
            transform: translateY(0);
        }

        /* YouBike è³‡è¨Šé¢æ¿ */
        #youbike-info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            padding: 20px;
            z-index: 35;
            font-family: Arial, sans-serif;
            border: 1px solid rgba(0,0,0,0.1);
            width: 85vw;
            max-width: 350px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
        }

        #youbike-info-panel .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        #youbike-info-panel .close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        #youbike-info-panel h3 {
            margin: 0 0 12px 0;
            color: #2222A0;
            font-size: 18px;
            padding-right: 30px;
        }

        #youbike-info-panel .info-item {
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            margin: 8px 0;
        }

        #youbike-info-panel .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <div id="æ¨™é¡Œ">å°ä¸­ YouBike 2.0 åœ°åœ–</div>
    <div id="åœ°åœ–å®¹å™¨" style="height:100vh;width:100vw;"></div>
    <div id="youbikePanel2D"></div>
    <!-- YouBike è³‡è¨Šé¢æ¿ -->
    <div id="youbike-info-panel">
        <button id="close-youbike-panel" class="close-btn">Ã—</button>
        <div id="youbike-info-content">
            <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
    </div>
    <button id="locationBtn" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" style="position: fixed; bottom: 160px; right: 15px; display: none;" title="ç§»å‹•åˆ°ç›®å‰ä½ç½®" aria-label="ç§»å‹•åˆ°ç›®å‰ä½ç½®" role="button">ğŸ”˜</button>
    <button id="youbikeToggleBtn" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" style="position: fixed; bottom: 110px; left: 15px;" title="é¡¯ç¤º/éš±è— YouBike é¢æ¿" aria-label="é¡¯ç¤º/éš±è— YouBike é¢æ¿" role="button">ğŸš²</button>
    <button id="toggleDebugBtn" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" style="position: fixed; bottom: 160px; left: 15px; display: none;" title="é¡¯ç¤º/éš±è—å®šä½è³‡è¨Š" aria-label="é¡¯ç¤º/éš±è—å®šä½è³‡è¨Š" role="button">â„¹ï¸</button>
    <div id="ç›¸æ©Ÿè³‡è¨Š" class="éš±è—">
        <div id="ç›¸æ©Ÿåƒæ•¸é¡¯ç¤º" style="display: none;"><!-- æš«æ™‚éš±è—ç›¸æ©Ÿåƒæ•¸ --></div>
        <div id="åµéŒ¯è³‡è¨Šå€å¡Š">
            <div id="åµéŒ¯æ¨™é¡Œ">å®šä½è³‡è¨Š (é»æ“Šå±•é–‹/æ‘ºç–Š)</div>
            <div id="åµéŒ¯å…§å®¹">Waiting for location... / ç­‰å¾…å®šä½ä¸­...</div>
        </div>
    </div>
    <script async defer>
        console.log('ğŸš€ é–‹å§‹è¼‰å…¥ Google Maps API...');
        console.log('ğŸ“ ç•¶å‰ç¶²åŸŸ:', window.location.href);
        
        (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; console.log('ğŸ“¡ è¼‰å…¥ Maps API URL:', a.src); d[q] = f; a.onerror = (err) => { console.error('âŒ Google Maps API è¼‰å…¥å¤±æ•—:', err); h = n(Error(p + " could not load.")); }; a.onload = () => { console.log('âœ… Google Maps API è…³æœ¬è¼‰å…¥æˆåŠŸ'); }; a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
            key: "AIzaSyDhFmyyK0ipeOreWD1D7Ry4wEE53EudGdA",
            v: "beta",
        });
        
        // ç›£è½ Google Maps API è¼‰å…¥å®Œæˆ
        window.addEventListener('load', () => {
            console.log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ');
            if (window.google && window.google.maps) {
                console.log('âœ… Google Maps API å·²å¯ç”¨');
            } else {
                console.log('âŒ Google Maps API ä¸å¯ç”¨');
            }
        });
    </script>
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let map2D;
        let youbikeStationsCache = null, currentUserPosition = null;
        let userLocationMarker = null;  // ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
        let flutterLocationData = null; // å„²å­˜ Flutter å‚³ä¾†çš„ä½ç½®
        let userHasClosedDebugPanel = false; // è¨˜éŒ„ä½¿ç”¨è€…æ˜¯å¦æ‰‹å‹•é—œé–‰äº†é¢æ¿
        let lastLocationUpdateTime = 0; // è¨˜éŒ„ä¸Šæ¬¡ä½ç½®æ›´æ–°æ™‚é–“
        let lastSignificantPosition = null; // è¨˜éŒ„ä¸Šæ¬¡é‡è¦ä½ç½®è®Šæ›´
        const LOCATION_UPDATE_INTERVAL = 35000; // å„ªåŒ–ï¼šç¸®çŸ­åˆ°35ç§’
        const SIGNIFICANT_MOVE_DISTANCE = 50; // æ–°å¢ï¼š50å…¬å°ºå…§è¦–ç‚ºç„¡é¡¯è‘—ç§»å‹•
        const map2DMarkers = new Map();
        let filterRadiusMeters2D = 2000;
        let markerSizePx2D = 48;
        let showYouBikeMarkers2D = true;
        let showMapIcons2D = true; // é è¨­é¡¯ç¤ºåœ°ååœ–æ¨™
        let infoWindow2D = null;

        const MAP_STYLES_HIDE_ICONS = [
            { elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'transit', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] }
        ];

        // --- åœ‹éš›åŒ–æ”¯æ´ ---
        let currentLanguage = 'zh'; // é è¨­ç¹é«”ä¸­æ–‡

        const translations = {
            zh: {
                // å®šä½è³‡è¨Š
                flutterLocation: 'Flutter å®šä½è³‡æ–™',
                browserLocation: 'ç€è¦½å™¨å®šä½è³‡æ–™',
                latitude: 'ç·¯åº¦',
                longitude: 'ç¶“åº¦',
                accuracy: 'ç²¾ç¢ºåº¦',
                meters: 'å…¬å°º',
                distance: 'ç§»å‹•è·é›¢',
                status: 'ç‹€æ…‹',
                locationSuccess: 'å®šä½æˆåŠŸ',
                smartUpdate: 'æ™ºèƒ½æ›´æ–°',
                time: 'æ™‚é–“',
                locationInfo: 'å®šä½è³‡è¨Š',
                clickToToggle: '(é»æ“Šå±•é–‹/æ‘ºç–Š)',
                waitingLocation: 'ç­‰å¾…å®šä½ä¸­...',
                usingBrowserLocation: 'ä½¿ç”¨ç€è¦½å™¨å®šä½ API',

                // YouBike ç‹€æ…‹
                youbikeStatus: 'YouBike',
                statusNormal: 'æ­£å¸¸',
                statusEmpty: 'ç„¡è»Š/ä½',
                statusLow: 'ä¸è¶³',
                statusMaintenance: 'ç¶­è­·ä¸­',

                // YouBike è³‡è¨Šé¢æ¿
                stationNumber: 'ç«™è™Ÿ',
                availableBikes: 'å¯å€Ÿè»Šè¼›',
                availableDocks: 'å¯é‚„è»Šä½',
                totalSlots: 'ç¸½è»Šä½æ•¸',
                electricBikes: 'é›»å‹•è»Š',
                bikes: 'è¼›',
                docks: 'å€‹',

                // è·é›¢æ™‚é–“
                distanceLabel: 'è·é›¢',
                walkingTime: 'æ­¥è¡Œç´„',
                cyclingTime: 'é¨è»Šç´„',
                minutes: 'åˆ†é˜',
                hours: 'å°æ™‚',
                kilometers: 'å…¬é‡Œ',
                noLocation: 'ç„¡æ³•å–å¾—ç›®å‰ä½ç½®',

                // ç«™é»ç‹€æ…‹æ–‡å­—
                normalOperation: 'æ­£å¸¸é‹ä½œ',
                noBikes: 'ç„¡è»Šå¯å€Ÿ',
                noDocks: 'ç„¡ä½å¯é‚„',
                insufficient: 'è»Šä½ä¸è¶³',
                maintenance: 'ç¶­è­·ä¸­',

                // å…¶ä»–
                yourLocation: 'æ‚¨çš„ä½ç½®',
                moveToCurrentLocation: 'ç§»å‹•åˆ°ç›®å‰ä½ç½®',
                showHideYoubike: 'é¡¯ç¤º/éš±è— YouBike é¢æ¿',
                showHideLocationInfo: 'é¡¯ç¤º/éš±è—å®šä½è³‡è¨Š'
            },
            en: {
                // Location Info
                flutterLocation: 'Flutter Location',
                browserLocation: 'Browser Location',
                latitude: 'Latitude',
                longitude: 'Longitude',
                accuracy: 'Accuracy',
                meters: 'meters',
                distance: 'Distance',
                status: 'Status',
                locationSuccess: 'Located',
                smartUpdate: 'Smart Update',
                time: 'Time',
                locationInfo: 'Location Info',
                clickToToggle: '(Click to expand/collapse)',
                waitingLocation: 'Waiting for location...',
                usingBrowserLocation: 'Using browser location API',

                // YouBike Status
                youbikeStatus: 'YouBike',
                statusNormal: 'Normal',
                statusEmpty: 'Empty',
                statusLow: 'Low',
                statusMaintenance: 'Maintenance',

                // YouBike Info Panel
                stationNumber: 'Station No.',
                availableBikes: 'Available Bikes',
                availableDocks: 'Available Docks',
                totalSlots: 'Total Slots',
                electricBikes: 'E-Bikes',
                bikes: 'bikes',
                docks: 'docks',

                // Distance & Time
                distanceLabel: 'Distance',
                walkingTime: 'Walk',
                cyclingTime: 'Bike',
                minutes: 'min',
                hours: 'hr',
                kilometers: 'km',
                noLocation: 'Unable to get current location',

                // Station Status
                normalOperation: 'Normal',
                noBikes: 'No bikes',
                noDocks: 'No docks',
                insufficient: 'Low stock',
                maintenance: 'Maintenance',

                // Others
                yourLocation: 'Your Location',
                moveToCurrentLocation: 'Move to current location',
                showHideYoubike: 'Show/Hide YouBike Panel',
                showHideLocationInfo: 'Show/Hide Location Info'
            }
        };

        // ç¿»è­¯å‡½æ•¸
        function t(key) {
            return translations[currentLanguage][key] || translations['zh'][key] || key;
        }

        // æ¥æ”¶ Flutter å‚³ä¾†çš„èªè¨€ä»£ç¢¼
        window.setLanguage = function(langCode) {
            console.log('âœ… æ”¶åˆ°èªè¨€ä»£ç¢¼:', langCode);
            currentLanguage = langCode === 'en' ? 'en' : 'zh';
            console.log('ğŸŒ åˆ‡æ›èªè¨€ç‚º:', currentLanguage);

            // æ›´æ–°é é¢æ¨™é¡Œ
            document.getElementById('æ¨™é¡Œ').textContent = currentLanguage === 'en'
                ? 'Taichung Bike Station Map'
                : 'å°ä¸­å–®è»Šç«™é»åœ°åœ–';

            // å¦‚æœå®šä½è³‡è¨Šå·²é¡¯ç¤ºï¼Œé‡æ–°æ¸²æŸ“
            if (flutterLocationData) {
                window.receiveFlutterLocation(flutterLocationData);
            }
        };

        // --- YouBike è³‡è¨Šé¢æ¿å‡½æ•¸ ---
        function showYouBikePanel(station) {
            const panel = document.getElementById('youbike-info-panel');
            const content = document.getElementById('youbike-info-content');

            const { statusSymbol, statusText } = getStationStatus(station);
            const distanceInfo = calculateDistanceAndTime(station);

            // æ ¹æ“šç‹€æ…‹è¨­å®šå¾½ç« é¡è‰²
            let badgeColor = '#34a853'; // ç¶ è‰²
            if (statusSymbol === 'ğŸ”´') badgeColor = '#d93025';
            else if (statusSymbol === 'ğŸŸ¡') badgeColor = '#fbbc04';
            else if (statusSymbol === 'ğŸŸ ') badgeColor = '#f29900';

            content.innerHTML = `
                <h3>ğŸš² ${station.name}</h3>
                <div class="status-badge" style="background: ${badgeColor}20; color: ${badgeColor}; border: 1px solid ${badgeColor};">
                    ${statusSymbol} ${statusText}
                </div>
                ${distanceInfo}
                <div class="info-item">
                    <strong>ç«™è™Ÿï¼š</strong>${station.id}
                </div>
                <div class="info-item">
                    <strong>ğŸš² å¯å€Ÿè»Šè¼›ï¼š</strong>${station.bikes} è¼›
                </div>
                <div class="info-item">
                    <strong>ğŸ…¿ï¸ å¯é‚„è»Šä½ï¼š</strong>${station.docks} å€‹
                </div>
                <div class="info-item">
                    <strong>ğŸ“Š ç¸½è»Šä½æ•¸ï¼š</strong>${station.totalSlots} å€‹
                </div>
                <div class="info-item">
                    <strong>âš¡ é›»å‹•è»Šï¼š</strong>${station.electricBikes} è¼›
                </div>
            `;

            panel.style.display = 'block';
        }

        function closeYouBikePanel() {
            const panel = document.getElementById('youbike-info-panel');
            panel.style.display = 'none';
        }

        // --- Flutter ä½ç½®æ¥æ”¶å‡½æ•¸ï¼šæ™ºèƒ½æ›´æ–°æ©Ÿåˆ¶ ---
        window.receiveFlutterLocation = function(locationData) {
            console.log('âœ… æ”¶åˆ° Flutter ä½ç½®è³‡æ–™:', locationData);

            // ğŸ”§ å„ªåŒ–ï¼šæ™‚é–“ç¯€æµ + è·é›¢åˆ¤æ–·ï¼ˆé¿å…é »ç¹æ›´æ–°ï¼‰
            const currentTime = Date.now();
            const timeSinceLastUpdate = currentTime - lastLocationUpdateTime;

            // è¨ˆç®—è·é›¢è®ŠåŒ–ï¼ˆhaversine å…¬å¼ï¼‰
            let distanceChanged = Infinity;
            if (lastSignificantPosition) {
                distanceChanged = haversineMeters(
                    lastSignificantPosition.lat, lastSignificantPosition.lng,
                    locationData.lat, locationData.lng
                );
            }

            // åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°ï¼šæ™‚é–“é–“éš”é”æ¨™ OR é¡¯è‘—ç§»å‹•
            const shouldUpdate = timeSinceLastUpdate >= LOCATION_UPDATE_INTERVAL ||
                               distanceChanged >= SIGNIFICANT_MOVE_DISTANCE;

            if (!shouldUpdate) {
                console.log(`â±ï¸ è·³éæ›´æ–° - è·é›¢: ${distanceChanged.toFixed(0)}m, æ™‚é–“: ${Math.round(timeSinceLastUpdate/1000)}s`);
                return;
            }

            console.log(`ğŸ”„ åŸ·è¡Œä½ç½®æ›´æ–° - è·é›¢è®ŠåŒ–: ${distanceChanged.toFixed(0)}m, æ™‚é–“é–“éš”: ${Math.round(timeSinceLastUpdate/1000)}s`);
            lastLocationUpdateTime = currentTime;
            lastSignificantPosition = { lat: locationData.lat, lng: locationData.lng };

            flutterLocationData = locationData;

            // æ›´æ–°ç›®å‰ä½ç½®
            currentUserPosition = {
                lat: locationData.lat,
                lng: locationData.lng
            };
            
            // é¡¯ç¤º debug è¨Šæ¯
            const debugDiv = document.getElementById('åµéŒ¯å…§å®¹');
            if (debugDiv) {
                const now = new Date();
                debugDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="flex: 1;">
                            <strong>${t('flutterLocation')} (${now.toLocaleTimeString()}):</strong><br>
                            ${t('latitude')}: ${locationData.lat.toFixed(6)}<br>
                            ${t('longitude')}: ${locationData.lng.toFixed(6)}<br>
                            ${t('accuracy')}: ${locationData.accuracy.toFixed(1)} ${t('meters')}<br>
                            ${t('distance')}: ${distanceChanged.toFixed(0)} ${t('meters')}<br>
                            ${t('status')}: âœ… ${t('locationSuccess')}<br>
                            <small style="color: #666;">${t('smartUpdate')} (${t('time')}${LOCATION_UPDATE_INTERVAL/1000}s / ${t('distance')}${SIGNIFICANT_MOVE_DISTANCE}m)</small>
                        </div>
                        <div style="border-top: 2px solid #e0e0e0; padding-top: 8px;">
                            <div style="font-size: 11px; font-weight: 600; color: #555; margin-bottom: 6px;">${t('youbikeStatus')}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 14px; height: 14px; background: #34a853; border-radius: 2px; flex-shrink: 0;"></span>
                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusNormal')}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 14px; height: 14px; background: #fbbc04; border-radius: 2px; flex-shrink: 0;"></span>
                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusEmpty')}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 14px; height: 14px; background: #f29900; border-radius: 2px; flex-shrink: 0;"></span>
                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusLow')}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 14px; height: 14px; background: #d93025; border-radius: 2px; flex-shrink: 0;"></span>
                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusMaintenance')}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('åµéŒ¯è³‡è¨Šå€å¡Š').style.display = 'block';
                document.getElementById('åµéŒ¯æ¨™é¡Œ').textContent = t('locationInfo') + ' ' + t('clickToToggle');

                // é¡¯ç¤ºå®šä½æŒ‰éˆ•å’Œè³‡è¨ŠæŒ‰éˆ•
                document.getElementById('toggleDebugBtn').style.display = 'block';
                document.getElementById('locationBtn').style.display = 'block';
            }

            // æ›´æ–°åœ°åœ–æ¨™è¨˜
            if (map2D) {
                updateUserLocationMarker(locationData);
            }
        };
        
        // æ›´æ–°ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
        function updateUserLocationMarker(locationData) {
            if (!map2D) {
                console.log('âŒ map2D ä¸å­˜åœ¨ï¼Œç„¡æ³•å‰µå»ºæ¨™è¨˜');
                return;
            }
            
            console.log('ğŸ“ é–‹å§‹æ›´æ–°ç”¨æˆ¶ä½ç½®æ¨™è¨˜:', locationData);
            
            const position = { lat: locationData.lat, lng: locationData.lng };
            
            // å¦‚æœæ¨™è¨˜å·²å­˜åœ¨ï¼Œæ›´æ–°ä½ç½®
            if (userLocationMarker) {
                console.log('ğŸ”„ æ›´æ–°ç¾æœ‰æ¨™è¨˜ä½ç½®');
                userLocationMarker.setPosition(position);
            } else {
                console.log('ğŸ†• å‰µå»ºæ–°çš„ä½ç½®æ¨™è¨˜');
                
                // å‰µå»ºæ–°çš„æ¨™è¨˜ - ä½¿ç”¨é†’ç›®çš„è—è‰²åœ“é»
                userLocationMarker = new google.maps.Marker({
                    position: position,
                    map: map2D,
                    title: 'æ‚¨çš„ä½ç½®',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15, // å¢å¤§å°ºå¯¸ä»¥æé«˜å¯è¦‹åº¦
                        fillColor: '#4285F4', // Google è—
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 4 // å¢åŠ ç™½è‰²é‚Šæ¡†å¯¬åº¦
                    },
                    zIndex: 999, // ç¢ºä¿åœ¨æœ€ä¸Šå±¤é¡¯ç¤º
                    optimized: false // é˜²æ­¢è¢«å„ªåŒ–éš±è—
                });
                
                // æ·»åŠ è„ˆå‹•æ•ˆæœçš„å¤–åœˆ
                const pulseMarker = new google.maps.Marker({
                    position: position,
                    map: map2D,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 25,
                        fillColor: '#4285F4',
                        fillOpacity: 0.3,
                        strokeColor: '#4285F4',
                        strokeWeight: 1
                    },
                    zIndex: 998
                });
                
                console.log('âœ… ä½ç½®æ¨™è¨˜å·²å‰µå»º:', userLocationMarker);
                
                // æ·»åŠ é»æ“Šäº‹ä»¶é¡¯ç¤ºè¨Šæ¯
                userLocationMarker.addListener('click', () => {
                    console.log('ğŸ” ä½ç½®æ¨™è¨˜è¢«é»æ“Š');
                    const info = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h3>æ‚¨çš„ä½ç½®</h3>
                                <p>ç·¯åº¦: ${locationData.lat.toFixed(6)}</p>
                                <p>ç¶“åº¦: ${locationData.lng.toFixed(6)}</p>
                                <p>ç²¾ç¢ºåº¦: ${locationData.accuracy.toFixed(1)} å…¬å°º</p>
                            </div>
                        `
                    });
                    info.open(map2D, userLocationMarker);
                });
            }
            
            // ç§»å‹•åœ°åœ–åˆ°ç›®å‰ä½ç½®
            map2D.panTo(position);
            
            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            console.log('ğŸ“ åœ°åœ–å·²ç§»å‹•åˆ°æ‚¨çš„ä½ç½®:', position);
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function haversineMeters(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calculateDistanceAndTime(station) {
            // å–å¾—ç›®å‰ä½ç½®ï¼ˆå„ªå…ˆä½¿ç”¨ Flutter ä½ç½®ï¼Œå…¶æ¬¡æ˜¯åœ°åœ–ä¸­å¿ƒï¼‰
            let currentPos = null;

            // å„ªå…ˆä½¿ç”¨ Flutter æä¾›çš„ä½ç½®
            if (flutterLocationData) {
                currentPos = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
            }
            // å¦‚æœæœ‰ç”¨æˆ¶ä½ç½®æ¨™è¨˜ï¼Œä½¿ç”¨è©²ä½ç½®
            else if (userLocationMarker) {
                const pos = userLocationMarker.getPosition();
                if (pos) {
                    currentPos = { lat: pos.lat(), lng: pos.lng() };
                }
            }
            // æœ€å¾Œä½¿ç”¨åœ°åœ–ä¸­å¿ƒä½ç½®
            else if (map2D) {
                const center = map2D.getCenter();
                if (center) {
                    currentPos = { lat: center.lat(), lng: center.lng() };
                }
            }

            if (!currentPos) {
                return `<div style="font-size:12px;color:#666;margin-bottom:6px;">ğŸ“ ${t('noLocation')}</div>`;
            }

            // è¨ˆç®—ç›´ç·šè·é›¢ï¼ˆå…¬å°ºï¼‰
            const distance = haversineMeters(currentPos.lat, currentPos.lng, station.lat, station.lng);

            // æ ¼å¼åŒ–è·é›¢
            let distanceText;
            if (distance < 1000) {
                distanceText = `${Math.round(distance)} ${t('meters')}`;
            } else {
                distanceText = `${(distance / 1000).toFixed(1)} ${t('kilometers')}`;
            }

            // ä¼°ç®—æ™‚é–“ï¼ˆæ­¥è¡Œé€Ÿåº¦ 5 km/hï¼Œé¨è»Šé€Ÿåº¦ 15 km/hï¼‰
            const walkingTimeMinutes = Math.round((distance / 1000) / 5 * 60);
            const cyclingTimeMinutes = Math.round((distance / 1000) / 15 * 60);

            let walkingTimeText, cyclingTimeText;

            if (walkingTimeMinutes < 60) {
                walkingTimeText = `${walkingTimeMinutes} ${t('minutes')}`;
            } else {
                const hours = Math.floor(walkingTimeMinutes / 60);
                const minutes = walkingTimeMinutes % 60;
                walkingTimeText = `${hours} ${t('hours')} ${minutes} ${t('minutes')}`;
            }

            if (cyclingTimeMinutes < 60) {
                cyclingTimeText = `${cyclingTimeMinutes} ${t('minutes')}`;
            } else {
                const hours = Math.floor(cyclingTimeMinutes / 60);
                const minutes = cyclingTimeMinutes % 60;
                cyclingTimeText = `${hours} ${t('hours')} ${minutes} ${t('minutes')}`;
            }

            return `
<div style="font-size:12px;color:#666;margin-bottom:6px;padding:4px;background:#f5f5f5;border-radius:4px;">
  <div>ğŸ“ ${t('distanceLabel')}ï¼š${distanceText}</div>
  <div>ğŸš¶ ${t('walkingTime')}ï¼š${walkingTimeText}</div>
  <div>ğŸš´ ${t('cyclingTime')}ï¼š${cyclingTimeText}</div>
</div>`;
        }

        function cleanStationName(rawName) {
            return String(rawName || '').replace(/^YouBike2\.0[_\s-]*/i, '');
        }

        // --- è¼”åŠ©å‡½æ•¸ï¼šå¸¶é‡è©¦çš„ fetch ---
        async function fetchWithRetry(url, options = {}, maxRetries = 3, delayMs = 2000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`ğŸ”„ å˜—è©¦è¼‰å…¥ (ç¬¬ ${i + 1}/${maxRetries} æ¬¡): ${url}`);
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response;
                } catch (err) {
                    console.warn(`âš ï¸ è¼‰å…¥å¤±æ•— (ç¬¬ ${i + 1}/${maxRetries} æ¬¡):`, err.message);
                    if (i < maxRetries - 1) {
                        console.log(`â³ ç­‰å¾… ${delayMs/1000} ç§’å¾Œé‡è©¦...`);
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    } else {
                        throw err; // æœ€å¾Œä¸€æ¬¡é‡è©¦å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤
                    }
                }
            }
        }

        // --- è³‡æ–™æ“·å–ï¼šYouBike API ä¸‰å±¤å‚™æ´æ©Ÿåˆ¶ ---
        async function loadYouBikeDataNormalized() {
            // å°ä¸­å¸‚è¡Œæ”¿å€åˆ—è¡¨ï¼ˆç”¨æ–¼éæ¿¾å‚™æ´ APIï¼‰
            const taichungDistricts = ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'åŒ—å±¯å€',
                'è±åŸå€', 'å¤§é‡Œå€', 'å¤ªå¹³å€', 'æ¸…æ°´å€', 'æ²™é¹¿å€', 'å¤§ç”²å€', 'æ±å‹¢å€', 'æ¢§æ£²å€', 'çƒæ—¥å€',
                'ç¥å²¡å€', 'å¤§è‚šå€', 'å¤§é›…å€', 'åé‡Œå€', 'éœ§å³°å€', 'æ½­å­å€', 'é¾äº•å€', 'å¤–åŸ”å€', 'å’Œå¹³å€',
                'çŸ³å²¡å€', 'å¤§å®‰å€', 'æ–°ç¤¾å€'];

            try {
                // 1. å„ªå…ˆä½¿ç”¨å°ä¸­å¸‚æ”¿åºœ APIï¼ˆè³‡æ–™å·²éæ¿¾ï¼Œåƒ…å°ä¸­å¸‚ç«™é»ï¼‰+ é‡è©¦æ©Ÿåˆ¶
                console.log('ğŸ”„ å˜—è©¦å¾å°ä¸­å¸‚æ”¿åºœ API è¼‰å…¥...');
                const apiUrl = 'https://datacenter.taichung.gov.tw/swagger/OpenData/bc27c2f7-6ed7-4f1a-b3cc-1a3cc9cda34e';
                const resp = await fetchWithRetry(apiUrl, { cache: 'no-store' }, 3, 2000);
                const rawData = await resp.json();
                const stations = Array.isArray(rawData.retVal) ? rawData.retVal : (Array.isArray(rawData) ? rawData : []);

                // è³‡æ–™æ­£è¦åŒ–è™•ç†
                const normalized = stations.map((s, i) => ({
                    id: String(s.sno || i), name: cleanStationName(s.sna), area: String(s.sarea || ''),
                    address: String(s.ar || ''), lat: Number(s.lat), lng: Number(s.lng),
                    totalSlots: Number(s.tot || 0), bikes: Number(s.sbi || 0), docks: Number(s.bemp || 0),
                    isActive: s.act == 1, yb2Bikes: Number(s.sbi_detail?.yb2 || 0),
                    electricBikes: Number(s.sbi_detail?.eyb || 0), lastUpdate: s.mday || ''
                })).filter(s => s.isActive && Number.isFinite(s.lat) && Number.isFinite(s.lng));

                console.info(`âœ… [YouBike] æˆåŠŸå¾å°ä¸­å¸‚ API è¼‰å…¥ ${normalized.length} å€‹ç«™é»ã€‚`);
                return normalized;
            } catch (err) {
                console.warn('âš ï¸ [YouBike] å°ä¸­å¸‚ API è¼‰å…¥å¤±æ•—ï¼ˆé‡è©¦ 3 æ¬¡å¾Œï¼‰ï¼Œå˜—è©¦å‚™æ´ API...', err);

                // 2. å‚™æ´ï¼šä½¿ç”¨å…¨å° API ä¸¦éæ¿¾å°ä¸­ç«™é» + é‡è©¦æ©Ÿåˆ¶
                try {
                    const backupUrl = 'https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json';
                    const resp = await fetchWithRetry(backupUrl, { cache: 'no-store' }, 3, 2000);
                    const rawData = await resp.json();
                    const stations = Array.isArray(rawData) ? rawData : [];

                    // éæ¿¾å°ä¸­å¸‚ç«™é»ï¼ˆä¾è¡Œæ”¿å€åç¨±ï¼‰
                    const normalized = stations
                        .filter(s => taichungDistricts.some(d => s.sarea && s.sarea.includes(d)))
                        .map((s, i) => ({
                            id: String(s.sno || i), name: cleanStationName(s.sna), area: String(s.sarea || ''),
                            address: String(s.ar || ''), lat: Number(s.latitude || s.lat), lng: Number(s.longitude || s.lng),
                            totalSlots: Number(s.total || s.tot || 0), bikes: Number(s.available_rent_bikes || s.sbi || 0),
                            docks: Number(s.available_return_bikes || s.bemp || 0),
                            isActive: s.act == 1 || s.act === '1', yb2Bikes: 0,
                            electricBikes: 0, lastUpdate: s.mday || s.updateTime || ''
                        }))
                        .filter(s => s.isActive && Number.isFinite(s.lat) && Number.isFinite(s.lng));

                    console.info(`âœ… [YouBike] æˆåŠŸå¾å‚™æ´ API è¼‰å…¥ ${normalized.length} å€‹å°ä¸­ç«™é»ã€‚`);
                    return normalized;
                } catch (backupErr) {
                    console.error('âŒ [YouBike] å‚™æ´ API ä¹Ÿè¼‰å…¥å¤±æ•—ï¼ˆé‡è©¦ 3 æ¬¡å¾Œï¼‰ï¼Œå˜—è©¦æœ¬åœ°è³‡æ–™...', backupErr);

                    // 3. æœ€çµ‚å‚™æ´ï¼šä½¿ç”¨æœ¬åœ° taichung.json
                    try {
                        console.log('ğŸ”„ è¼‰å…¥æœ¬åœ° YouBike è³‡æ–™ (taichung.json)...');
                        const localResp = await fetch('taichung.json');
                        if (!localResp.ok) throw new Error(`HTTP ${localResp.status}`);
                        const rawData = await localResp.json();
                        const stations = Array.isArray(rawData.retVal) ? rawData.retVal : (Array.isArray(rawData) ? rawData : []);

                        const normalized = stations.map((s, i) => ({
                            id: String(s.sno || i), name: cleanStationName(s.sna), area: String(s.sarea || ''),
                            address: String(s.ar || ''), lat: Number(s.lat), lng: Number(s.lng),
                            totalSlots: Number(s.tot || 0), bikes: Number(s.sbi || 0), docks: Number(s.bemp || 0),
                            isActive: s.act == 1, yb2Bikes: Number(s.sbi_detail?.yb2 || 0),
                            electricBikes: Number(s.sbi_detail?.eyb || 0), lastUpdate: s.mday || ''
                        })).filter(s => s.isActive && Number.isFinite(s.lat) && Number.isFinite(s.lng));

                        console.warn(`âš ï¸ [YouBike] ä½¿ç”¨æœ¬åœ°è³‡æ–™è¼‰å…¥ ${normalized.length} å€‹ç«™é»ï¼ˆè³‡æ–™å¯èƒ½ä¸æ˜¯æœ€æ–°ï¼‰ã€‚`);
                        return normalized;
                    } catch (localErr) {
                        console.error('âŒ [YouBike] æœ¬åœ°è³‡æ–™ä¹Ÿè¼‰å…¥å¤±æ•—ï¼š', localErr);
                        alert('âš ï¸ YouBike è³‡æ–™è¼‰å…¥å¤±æ•—\n\nç„¡æ³•å¾ç·šä¸Š API æˆ–æœ¬åœ°æª”æ¡ˆè¼‰å…¥ YouBike ç«™é»è³‡æ–™ã€‚\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚');
                        return [];
                    }
                }
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        async function init() {
            try {
                console.log('ğŸ”„ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
                
                // æª¢æŸ¥ Google Maps API æ˜¯å¦å·²è¼‰å…¥
                if (!window.google || !window.google.maps) {
                    console.log('â³ ç­‰å¾… Google Maps API è¼‰å…¥...');
                    // ç­‰å¾… API è¼‰å…¥
                    await new Promise((resolve, reject) => {
                        const checkInterval = setInterval(() => {
                            if (window.google && window.google.maps) {
                                console.log('âœ… Google Maps API å·²è¼‰å…¥');
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                        
                        // 30ç§’è¶…æ™‚
                        setTimeout(() => {
                            clearInterval(checkInterval);
                            reject(new Error('Google Maps API è¼‰å…¥è¶…æ™‚'));
                        }, 30000);
                    });
                }

                await show2DMap(); // è¼‰å…¥ 2D YouBike åœ°åœ–
                setupEventListeners();
                
                console.log('âœ… æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
                const container = document.getElementById('åœ°åœ–å®¹å™¨');
                container.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #f5f5f5;">
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            <h3 style="color: #d32f2f; margin-bottom: 10px;">âŒ åœ°åœ–è¼‰å…¥å¤±æ•—</h3>
                            <p style="color: #666; margin-bottom: 15px;">Google Maps API ç„¡æ³•è¼‰å…¥</p>
                            <button onclick="location.reload()" style="background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                ğŸ”„ é‡æ–°è¼‰å…¥
                            </button>
                            <div style="margin-top: 15px; font-size: 12px; color: #999;">
                                éŒ¯èª¤è©³æƒ…: ${error.message}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ğŸ”§ å„ªåŒ–ï¼šä½¿ç”¨äº‹ä»¶é©…å‹•æ›¿ä»£å®šæ™‚æª¢æŸ¥
            if (typeof window !== 'undefined') {
                // ä¸å†ä½¿ç”¨ setIntervalï¼Œæ”¹ç‚ºäº‹ä»¶é©…å‹•æ¨¡å¼
                console.log('âœ… è¨­å®šäº‹ä»¶é©…å‹•ä½ç½®æ›´æ–°æ¨¡å¼');
                
                // å¦‚æœéœ€è¦ Web å¹³å°æ”¯æ´ï¼Œå¯ä»¥ç›£è½ storage äº‹ä»¶
                window.addEventListener('storage', (e) => {
                    if (e.key === 'flutterLocation' && e.newValue) {
                        try {
                            const data = JSON.parse(e.newValue);
                            if (data && data.lat && data.lng && map2D) {
                                currentUserPosition = { lat: data.lat, lng: data.lng };
                                updateUserLocationMarker(data);
                                localStorage.removeItem('flutterLocation'); // æ¸…é™¤é¿å…é‡è¤‡
                            }
                        } catch (error) {
                            console.warn('ä½ç½®è³‡æ–™è§£æå¤±æ•—:', error);
                        }
                    }
                });
            }
        }

        function setupEventListeners() {
            // å®šä½è³‡è¨Šé¢æ¿åˆ‡æ›
            document.getElementById('toggleDebugBtn').onclick = () => {
                const panel = document.getElementById('ç›¸æ©Ÿè³‡è¨Š');
                const wasHidden = panel.classList.contains('éš±è—');
                panel.classList.toggle('éš±è—');
                const btn = document.getElementById('toggleDebugBtn');
                btn.textContent = panel.classList.contains('éš±è—') ? 'â„¹ï¸' : 'âœ•';

                // è¨˜éŒ„ä½¿ç”¨è€…çš„é¸æ“‡
                if (wasHidden) {
                    // ä½¿ç”¨è€…ä¸»å‹•é–‹å•Ÿ
                    userHasClosedDebugPanel = false;
                } else {
                    // ä½¿ç”¨è€…ä¸»å‹•é—œé–‰
                    userHasClosedDebugPanel = true;
                }
            };

            // è³‡è¨Šé¢æ¿é—œé–‰æŒ‰éˆ•
            document.getElementById('close-youbike-panel').onclick = closeYouBikePanel;

            // é»æ“Šåœ°åœ–å®¹å™¨æ™‚ï¼Œé—œé–‰ YouBike é¢æ¿
            document.getElementById('åœ°åœ–å®¹å™¨').addEventListener('click', () => {
                closeYouBikePanel();
            });
        }


        async function show2DMap() {
            await google.maps.importLibrary('maps');
            const container = document.getElementById('åœ°åœ–å®¹å™¨');
            container.innerHTML = '';
            map2D = new google.maps.Map(container, { 
                center: { lat: 24.147736, lng: 120.673648 }, 
                zoom: 13, 
                mapTypeId: 'roadmap',
                // ç¦ç”¨é»˜è®¤æ§ä»¶
                zoomControl: false,           // ç¦ç”¨ç¼©æ”¾æŒ‰é’®
                mapTypeControl: false,        // ç¦ç”¨åœ°å›¾ç±»å‹åˆ‡æ¢
                scaleControl: false,          // ç¦ç”¨æ¯”ä¾‹å°º
                streetViewControl: false,     // ç¦ç”¨è¡—æ™¯æ§ä»¶ï¼ˆé»„è‰²äººå‹å›¾æ ‡ï¼‰
                rotateControl: false,         // ç¦ç”¨æ—‹è½¬æ§ä»¶
                fullscreenControl: false,     // ç¦ç”¨å…¨å±æ§ä»¶
                gestureHandling: 'greedy'     // ä¼˜åŒ–è§¦æ‘¸æ‰‹åŠ¿
            });
            infoWindow2D = new google.maps.InfoWindow();

            if (!showMapIcons2D) map2D.setOptions({ styles: MAP_STYLES_HIDE_ICONS });

            // 2D æ¨¡å¼æ™‚ï¼Œå¦‚æœå·²æœ‰å®šä½è³‡æ–™å‰‡é¡¯ç¤ºæŒ‰éˆ•ï¼Œä½†é è¨­ä¸å±•é–‹é¢æ¿
            if (flutterLocationData) {
                document.getElementById('toggleDebugBtn').style.display = 'block';
                document.getElementById('locationBtn').style.display = 'block';
                // é è¨­ä¸è‡ªå‹•å±•é–‹ï¼Œè®“ä½¿ç”¨è€…æ‰‹å‹•é»æ“Š â„¹ï¸ é–‹å•Ÿ
            }

            buildYouBike2DPanel();
            setupLocationButton(); // åˆå§‹åŒ–å®šä½æŒ‰éˆ•

            // å„ªå…ˆä½¿ç”¨ Flutter ä½ç½®ï¼Œå¦å‰‡ä½¿ç”¨ç€è¦½å™¨å®šä½
            const useCenterAndRender = async (center) => {
                map2D.setCenter(center);
                map2D.setZoom(16);  // æ”¾å¤§åˆ°æ›´è©³ç´°çš„ç´šåˆ¥
                if (!youbikeStationsCache) youbikeStationsCache = await loadYouBikeDataNormalized();
                render2DYouBikeMarkers(center);
            };

            // å¦‚æœå·²æœ‰ Flutter ä½ç½®è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨
            if (flutterLocationData) {
                console.log('âœ… ä½¿ç”¨ Flutter ä½ç½®è³‡æ–™');
                currentUserPosition = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
                updateUserLocationMarker(flutterLocationData);
                useCenterAndRender(currentUserPosition);
            } else {
                // åœ¨ Flutter WebView ä¸­ï¼Œç­‰å¾… Flutter å‚³é€ä½ç½®
                console.log('â³ ç­‰å¾… Flutter ä½ç½®è³‡æ–™...');
                useCenterAndRender({ lat: 24.147736, lng: 120.673648 });

                // å˜—è©¦ç€è¦½å™¨å®šä½ï¼ˆåƒ…ç”¨æ–¼ Web å¹³å°ï¼‰
                if (navigator.geolocation && typeof flutter_inappwebview === 'undefined') {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log('âœ… ç€è¦½å™¨å®šä½æˆåŠŸ:', pos.coords);
                            currentUserPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };

                            const locationData = {
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                                accuracy: pos.coords.accuracy
                            };
                            updateUserLocationMarker(locationData);
                            useCenterAndRender(currentUserPosition);

                            // é¡¯ç¤ºå®šä½è³‡è¨ŠæŒ‰éˆ•å’Œæ›´æ–°è³‡è¨Š
                            const debugDiv = document.getElementById('åµéŒ¯å…§å®¹');
                            if (debugDiv) {
                                const now = new Date();
                                debugDiv.innerHTML = `
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="flex: 1;">
                                            <strong>${t('browserLocation')} (${now.toLocaleTimeString()}):</strong><br>
                                            ${t('latitude')}: ${locationData.lat.toFixed(6)}<br>
                                            ${t('longitude')}: ${locationData.lng.toFixed(6)}<br>
                                            ${t('accuracy')}: ${locationData.accuracy.toFixed(1)} ${t('meters')}<br>
                                            ${t('status')}: âœ… ${t('locationSuccess')}<br>
                                            <small style="color: #666;">${t('usingBrowserLocation')}</small>
                                        </div>
                                        <div style="border-top: 2px solid #e0e0e0; padding-top: 8px;">
                                            <div style="font-size: 11px; font-weight: 600; color: #555; margin-bottom: 6px;">${t('youbikeStatus')}</div>
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span style="width: 14px; height: 14px; background: #34a853; border-radius: 2px; flex-shrink: 0;"></span>
                                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusNormal')}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span style="width: 14px; height: 14px; background: #fbbc04; border-radius: 2px; flex-shrink: 0;"></span>
                                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusEmpty')}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span style="width: 14px; height: 14px; background: #f29900; border-radius: 2px; flex-shrink: 0;"></span>
                                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusLow')}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span style="width: 14px; height: 14px; background: #d93025; border-radius: 2px; flex-shrink: 0;"></span>
                                                    <span style="font-size: 11px; white-space: nowrap;">${t('statusMaintenance')}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                document.getElementById('åµéŒ¯è³‡è¨Šå€å¡Š').style.display = 'block';
                                document.getElementById('toggleDebugBtn').style.display = 'block';
                                document.getElementById('locationBtn').style.display = 'block';
                            }
                        },
                        (error) => {
                            console.log('â„¹ï¸ ç€è¦½å™¨å®šä½ä¸å¯ç”¨ï¼ˆæ­£å¸¸ï¼Œåœ¨ Flutter ä¸­ä½¿ç”¨ Flutter å®šä½ï¼‰');
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
                    );
                }
            }

            map2D.addListener('idle', () => render2DYouBikeMarkers(map2D.getCenter().toJSON()));
        }

        // --- 2D åŠŸèƒ½ ---
        function setupLocationButton() {
            const locationBtn = document.getElementById('locationBtn');
            if (!locationBtn) return;

            locationBtn.onclick = () => {
                // å„ªå…ˆä½¿ç”¨ Flutter ä½ç½®
                if (flutterLocationData) {
                    console.log('âœ… ä½¿ç”¨ Flutter ä½ç½®ç§»å‹•åœ°åœ–');
                    const pos = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
                    map2D.setCenter(pos);
                    map2D.setZoom(16);

                    // ç¢ºä¿ç”¨æˆ¶ä½ç½®æ¨™è¨˜å­˜åœ¨ä¸¦æ›´æ–°
                    if (userLocationMarker) {
                        userLocationMarker.setPosition(pos);
                    } else {
                        updateUserLocationMarker(flutterLocationData);
                    }
                    return;
                }

                // åƒ…åœ¨é Flutter ç’°å¢ƒä½¿ç”¨ç€è¦½å™¨å®šä½ API
                if (navigator.geolocation && typeof flutter_inappwebview === 'undefined') {
                    locationBtn.style.opacity = '0.6'; // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map2D.setCenter(pos);
                            map2D.setZoom(16);

                            // å‰µå»ºæˆ–æ›´æ–°ä½ç½®æ¨™è¨˜
                            const locationData = {
                                lat: pos.lat,
                                lng: pos.lng,
                                accuracy: position.coords.accuracy
                            };
                            updateUserLocationMarker(locationData);

                            locationBtn.style.opacity = '1'; // æ¢å¾©æ­£å¸¸ç‹€æ…‹
                            console.log('âœ… ç€è¦½å™¨å®šä½æˆåŠŸï¼Œå·²ç§»å‹•åˆ°ç›®å‰ä½ç½®');
                        },
                        (error) => {
                            locationBtn.style.opacity = '1'; // æ¢å¾©æ­£å¸¸ç‹€æ…‹
                            console.log('â„¹ï¸ å®šä½ä¸å¯ç”¨:', error.message);
                            alert('ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèªå·²å…è¨±ä½ç½®å­˜å–æ¬Šé™');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                } else {
                    console.log('â„¹ï¸ è«‹ç­‰å¾… Flutter æä¾›ä½ç½®è³‡æ–™');
                    alert('æ­£åœ¨ç­‰å¾…ä½ç½®è³‡æ–™...');
                }
            };
        }

        function buildYouBike2DPanel() {
            const panel = document.getElementById('youbikePanel2D');
            panel.innerHTML = '';
            panel.classList.add('youbikeé¢æ¿éš±è—');

            let isPanelVisible = false;
            document.getElementById('youbikeToggleBtn').onclick = () => {
                isPanelVisible = !isPanelVisible;
                panel.classList.toggle('youbikeé¢æ¿éš±è—', !isPanelVisible);
            };

            const title = document.createElement('div');
            title.style.cssText = 'font-weight:bold; font-family:Arial,sans-serif;';
            title.textContent = 'YouBike 2.0 å–®è»Šç«™é»';
            panel.appendChild(title);

            [
                { label: 'é¡¯ç¤ºå–®è»Šåœ–æ¨™', type: 'checkbox', checked: showYouBikeMarkers2D, onchange: (c) => { showYouBikeMarkers2D = c; render2DYouBikeMarkers(map2D.getCenter().toJSON(), true); } },
                { label: 'é¡¯ç¤ºåœ°ååœ–æ¨™', type: 'checkbox', checked: showMapIcons2D, onchange: (c) => { showMapIcons2D = c; map2D.setOptions({ styles: c ? null : MAP_STYLES_HIDE_ICONS }); } },
                { label: `æœå°‹åŠå¾‘ï¼š${filterRadiusMeters2D}m`, type: 'range', min: 500, max: 5000, value: filterRadiusMeters2D, oninput: (v, el) => { filterRadiusMeters2D = v; el.textContent = `æœå°‹åŠå¾‘ï¼š${v}m`; }, onchange: () => render2DYouBikeMarkers(map2D.getCenter().toJSON(), true) },
                { label: `æ¨™è¨˜å¤§å°ï¼š${markerSizePx2D}px`, type: 'range', min: 28, max: 72, value: markerSizePx2D, oninput: (v, el) => { markerSizePx2D = v; el.textContent = `æ¨™è¨˜å¤§å°ï¼š${v}px`; }, onchange: () => render2DYouBikeMarkers(map2D.getCenter().toJSON(), true) }
            ].forEach(item => {
                const group = document.createElement('div');
                group.className = 'control-group';
                const labelEl = document.createElement('label');
                labelEl.textContent = item.label;
                const inputEl = document.createElement('input');
                Object.assign(inputEl, { type: item.type, min: item.min, max: item.max, value: item.value, checked: item.checked });
                inputEl.oninput = () => item.oninput?.(inputEl.type === 'checkbox' ? inputEl.checked : parseInt(inputEl.value, 10), labelEl);
                inputEl.onchange = () => item.onchange?.(inputEl.type === 'checkbox' ? inputEl.checked : parseInt(inputEl.value, 10));
                group.append(labelEl, inputEl);
                panel.appendChild(group);
            });
        }

        // ğŸ”§ å„ªåŒ–ï¼šå¢åŠ æ¸²æŸ“ç¯€æµå’Œé‡è¤‡æª¢æŸ¥ï¼ˆé¿å…éåº¦æ¸²æŸ“ï¼‰
        let lastRenderCenter = null;        // ä¸Šæ¬¡æ¸²æŸ“çš„åœ°åœ–ä¸­å¿ƒ
        let isRendering = false;            // æ¸²æŸ“é€²è¡Œä¸­æ¨™è¨˜
        let renderRequestId = null;         // requestAnimationFrame ID
        const MIN_RENDER_DISTANCE = 100;    // åœ°åœ–ä¸­å¿ƒç§»å‹•100å…¬å°ºä»¥ä¸Šæ‰é‡æ–°æ¸²æŸ“

        function render2DYouBikeMarkers(center, forceRender = false) {
            if (!Array.isArray(youbikeStationsCache) || !map2D) return;
            if (!showYouBikeMarkers2D) { clear2DMarkers(); return; }

            // ğŸ”§ å„ªåŒ–ï¼šæª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ï¼ˆé™¤éå¼·åˆ¶æ¸²æŸ“ï¼‰
            if (!forceRender && lastRenderCenter) {
                const moveDistance = haversineMeters(
                    lastRenderCenter.lat, lastRenderCenter.lng,
                    center.lat, center.lng
                );
                if (moveDistance < MIN_RENDER_DISTANCE) {
                    console.log(`â±ï¸ è·³é YouBike æ¸²æŸ“ - ç§»å‹•è·é›¢: ${moveDistance.toFixed(0)}m < ${MIN_RENDER_DISTANCE}m`);
                    return;
                }
            }

            // ğŸ”§ å„ªåŒ–ï¼šé˜²æ­¢é‡è¤‡æ¸²æŸ“
            if (isRendering) {
                console.log('â±ï¸ YouBike æ¸²æŸ“é€²è¡Œä¸­ï¼Œè·³éæ­¤æ¬¡è«‹æ±‚');
                return;
            }

            // ğŸ”§ å„ªåŒ–ï¼šå–æ¶ˆä¹‹å‰çš„æ¸²æŸ“è«‹æ±‚
            if (renderRequestId) {
                cancelAnimationFrame(renderRequestId);
            }

            // ğŸ”§ å„ªåŒ–ï¼šä½¿ç”¨ requestAnimationFrame æå‡æ€§èƒ½
            renderRequestId = requestAnimationFrame(() => {
                performYouBikeRender(center);
            });
        }

        function performYouBikeRender(center) {
            isRendering = true;
            console.log(`ğŸ”„ YouBike æ¸²æŸ“é–‹å§‹ - ä¸­å¿ƒ: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);

            const startTime = performance.now();
            const within = youbikeStationsCache.filter(st => 
                haversineMeters(center.lat, center.lng, st.lat, st.lng) <= filterRadiusMeters2D
            );

            const toDelete = new Set(map2DMarkers.keys());
            let updatedCount = 0;
            let createdCount = 0;

            within.forEach(st => {
                const icon = buildBikeIcon(statusColorForStation(st), markerSizePx2D);
                if (map2DMarkers.has(st.id)) {
                    const mk = map2DMarkers.get(st.id);
                    mk.setIcon(icon);
                    mk.setPosition({ lat: st.lat, lng: st.lng });
                    updatedCount++;
                } else {
                    const mk = new google.maps.Marker({ 
                        position: { lat: st.lat, lng: st.lng }, 
                        map: map2D, 
                        title: `${st.name}ï½œå€Ÿ:${st.bikes} é‚„:${st.docks}`, 
                        icon 
                    });
                    mk.addListener('click', () => {
                        const { statusSymbol, statusText } = getStationStatus(st);

                        // ä½¿ç”¨æ–°çš„è·é›¢å’Œæ™‚é–“è¨ˆç®—å‡½æ•¸
                        const distanceInfo = calculateDistanceAndTime(st);

                        infoWindow2D.setContent(`<div style="font-family:Arial, sans-serif; min-width: 240px;">
                          <div style="font-size:14px;color:#666;margin-bottom:4px;">ç«™è™Ÿ: ${st.id}</div>
                          <div style="font-weight:700;font-size:18px;margin-bottom:8px;color:#111;">${st.name}</div>
                          <div style="font-size:14px;margin-bottom:8px;color:#333;">ç‹€æ…‹: ${statusSymbol} ${statusText}</div>
                          ${distanceInfo}
                          <div style="font-size:14px;line-height:1.5;">
                            <div>ğŸš² å¯å€Ÿè»Šè¼›ï¼š${st.bikes}</div>
                            <div>ğŸ…¿ï¸ å¯é‚„è»Šä½ï¼š${st.docks}</div>
                            <div>ğŸ“Š ç¸½è»Šä½æ•¸ï¼š${st.totalSlots}</div>
                            <div>âš¡ é›»å‹•è»Šï¼š${st.electricBikes}</div>
                          </div>
                        </div>`);
                        infoWindow2D.open({ map: map2D, anchor: mk, shouldFocus: false });
                    });
                    map2DMarkers.set(st.id, mk);
                    createdCount++;
                }
                toDelete.delete(st.id);
            });

            // æ‰¹é‡åˆªé™¤è¶…å‡ºç¯„åœçš„æ¨™è¨˜
            let deletedCount = 0;
            for (const id of toDelete) {
                map2DMarkers.get(id)?.setMap(null);
                map2DMarkers.delete(id);
                deletedCount++;
            }

            const endTime = performance.now();
            const renderTime = endTime - startTime;
            
            console.log(`âœ… YouBike æ¸²æŸ“å®Œæˆ - ç”¨æ™‚: ${renderTime.toFixed(1)}ms, å‰µå»º: ${createdCount}, æ›´æ–°: ${updatedCount}, åˆªé™¤: ${deletedCount}, ç¸½æ•¸: ${within.length}`);
            
            lastRenderCenter = { lat: center.lat, lng: center.lng };
            isRendering = false;
            renderRequestId = null;
        }

        function clear2DMarkers() {
            for (const mk of map2DMarkers.values()) mk.setMap(null);
            map2DMarkers.clear();
        }

        function getStationStatus(st) {
            if (!st.isActive) return { statusSymbol: 'ğŸ”´', statusText: t('maintenance') };
            if (st.bikes === 0) return { statusSymbol: 'ğŸŸ¡', statusText: t('noBikes') };
            if (st.docks === 0) return { statusSymbol: 'ğŸŸ¡', statusText: t('noDocks') };
            if (st.bikes <= 2 || st.docks <= 2) return { statusSymbol: 'ğŸŸ ', statusText: t('insufficient') };
            return { statusSymbol: 'ğŸŸ¢', statusText: t('normalOperation') };
        }

        function statusColorForStation(st) {
            const status = getStationStatus(st).statusSymbol;
            if (status === 'ğŸ”´') return '#d93025';
            if (status === 'ğŸŸ¡') return '#fbbc04';
            if (status === 'ğŸŸ ') return '#f29900';
            return '#34a853';
        }

        // --- YouBike åœ–æ¨™å»ºæ§‹ï¼šå°ä¸­ç‰¹è‰²è¨­è¨ˆ ---
        function buildBikeIcon(color, sizePx) {
            const s = Math.max(28, Math.min(72, sizePx));
            const stroke = '#0f172a';          // é»‘è‰²é‚Šæ¡†
            const halo = '#ffffff';            // ç™½è‰²å…‰æšˆ
            const wheelColor = color;          // è¼ªèƒç”¨ç‹€æ…‹é¡è‰²ï¼ˆç¶ /é»ƒ/æ©™/ç´…ï¼‰
            const wheelRim = '#FFD700';        // é»ƒè‰²è¼ªæ¡†ï¼ˆå°ä¸­ YouBike ç‰¹è‰²ï¼‰
            const frameBlack = '#0f172a';      // é»‘è‰²éª¨æ¶
            const frameOutline = '#FFFFFF';    // ç™½è‰²å¤–æ¡†ï¼ˆ1px æ¥µç´°ï¼‰
            const seat = '#111827';            // é»‘è‰²è»Šåº§
            const basket = '#FFD700';          // é»ƒè‰²ç½®ç‰©ç›’

            // SVG åœ–æ¨™ï¼šå°ä¸­ YouBike 2.0 é€ å‹
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns='http://www.w3.org/2000/svg' width='${s}' height='${s}' viewBox='0 0 32 32'>
  <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
    <feDropShadow dx="1" dy="1" stdDeviation="1.5" flood-color="#000000" flood-opacity="0.4"/>
  </filter>
  <!-- å¤–åœˆç™½æšˆï¼ˆæå‡å¯è¦‹åº¦ï¼‰ -->
  <g fill='${halo}' stroke='${halo}' stroke-width='4' opacity='0.9' filter="url(#shadow)">
    <circle cx='9' cy='22' r='7'/>
    <circle cx='23' cy='22' r='7'/>
  </g>
  <!-- è»Šè¼ªï¼ˆç‹€æ…‹è‰²å¡«å……ï¼šç¶ =æ­£å¸¸ï¼Œé»ƒ=ç„¡è»Š/ä½ï¼Œæ©™=ä¸è¶³ï¼Œç´…=ç¶­è­·ï¼‰-->
  <g fill='${wheelColor}' stroke='${stroke}' stroke-width='1.2' filter="url(#shadow)">
    <circle cx='9' cy='22' r='6'/>
    <circle cx='23' cy='22' r='6'/>
  </g>
  <!-- é»ƒè‰²è¼ªæ¡†ï¼ˆå°ä¸­ YouBike ç‰¹è‰²ï¼‰ -->
  <g fill='none' stroke='${wheelRim}' stroke-width='2.5' opacity='0.9'>
    <circle cx='9' cy='22' r='5'/>
    <circle cx='23' cy='22' r='5'/>
  </g>
  <!-- é»‘è‰²è»Šæ¶ -->
  <g fill='none' stroke='${frameBlack}' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round' filter="url(#shadow)">
    <path d='M9 22l6-10h6l6 10' />
    <path d='M15 12l3 7M12 16h6' />
  </g>
  <!-- è»Šæ¶ç™½è‰²æ¥µç´°å¤–æ¡†ï¼ˆ1pxï¼Œå¢åŠ å°æ¯”ï¼‰ -->
  <g fill='none' stroke='${frameOutline}' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'>
    <path d='M9 22l6-10h6l6 10' />
    <path d='M15 12l3 7M12 16h6' />
  </g>
  <!-- å‰ç½®ç‰©ç›’ï¼ˆå°ä¸­ YouBike ç‰¹è‰²ï¼‰ -->
  <g filter="url(#shadow)">
    <rect x='25' y='11' width='5' height='4' rx='0.8' fill='${basket}' stroke='${stroke}' stroke-width='0.8' />
    <line x1='25' y1='13' x2='30' y2='13' stroke='${stroke}' stroke-width='0.5' />
  </g>
  <!-- è»Šåº§ -->
  <g fill='${seat}' stroke='${stroke}' stroke-width='1.2' filter="url(#shadow)">
    <rect x='14.5' y='9' width='4' height='1.6' rx='0.6' />
  </g>
</svg>`;
            const url = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
            return {
                url,
                scaledSize: new google.maps.Size(s, s),
                anchor: new google.maps.Point(s/2, s/2)
            };
        }

        // ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾Œå†åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
            init();
        }
    </script>
</body>

</html>